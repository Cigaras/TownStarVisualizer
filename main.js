var grid = {
  name: "4x4",
  defaultType: "Grass",
  grid: [],
  northborder: "none",
  southborder: "none",
  eastborder: "none",
  westborder: "none",
};

var exportGrid = {
  name: "export",
  defaultType: "Grass",
  grid: [],
  northborder: "none",
  southborder: "none",
  eastborder: "none",
  westborder: "none",
};

var templateGrid = {
  name: "export",
  defaultType: "Grass",
  grid: [
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "pond" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "wheatfield" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "wheatfield" },
    { type: "dirtroad" },
    { type: "dirtroad" },
    { type: "dirtroad" },
    { type: "farmhouse" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "dirtroad" },
    { type: "well" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "dirtroad" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "dirtroad" },
    { type: "silo" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "dirtroad" },
    { type: "dirtroad" },
    { type: "dirtroad" },
    { type: "dirtroad" },
    { type: "dirtroad" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "tradedepot" },
    { type: "oilpump" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
    { type: "grass" },
  ],
  northborder: "none",
  southborder: "none",
  eastborder: "none",
  westborder: "none",
};

const borderTypes = ["none", "River", "Ocean", "Mountain"];
const biomes = ["Forest", "Plains", "Desert"];
const borders = ["northborder", "westborder", "southborder", "eastborder"];
const excludedBuildings = ["Air_Cargo", "Gift_Drone", "Construction_Site"];
const passiveTypes = [
  "Water",
  "Shady",
  "Energy",
  "Dirty",
  "Wheat",
  "Sugarcane",
  "Cotton",
  "Salty",
  "Crude_Oil",
  "Water_Drum",
];
const removeIcon =
  "files/assets/24720670/1/icon_remove.png?t=398216d9dcf6d8448c798548add05f76";

var overlayMode = "none";
var dimension = 16;
var selected = "";
var selectedBuilding = "";
var biome = "Forest";
var direction = "north";

function initialize() {
  loadTemplateGrid();
  loadGrid();
  renderGrid();
  renderBuildingMenu();
  renderOverlaysOptions();
  renderBiomeOptions();
}

function loadTemplateGrid() {
  grid.northborder = templateGrid.northborder;
  grid.southborder = templateGrid.southborder;
  grid.eastborder = templateGrid.eastborder;
  grid.westborder = templateGrid.westborder;
  if (biome == "none") {
    clearGrid();
  } else {
    templateGrid.grid = getGridFromMap(biome, direction);
    setDefaultType();
    grid.grid = templateGrid.grid.map((cell) => {
      return {
        type: cell.type,
        edgeSatisfied: true,
      };
    });
  }

  updateExportGrid();
}

function setDefaultType() {
  if (biome == "Desert") {
    grid.defaultType = "Arid";
  } else {
    grid.defaultType = "Grass";
  }
}

function importGrid() {
  if ($("#importexport").val() != "") {
    var importedGrid = JSON.parse($("#importexport").val());
    grid.northborder = importedGrid.northborder;
    grid.southborder = importedGrid.southborder;
    grid.eastborder = importedGrid.eastborder;
    grid.westborder = importedGrid.westborder;
    grid.grid = importedGrid.grid.map((cell) => {
      return {
        type: cell.type,
        edgeSatisfied: true,
      };
    });
    renderBorders();
    renderGrid();
  }
}

function renderOverlaysOptions() {
  var optionsHtml = "<option value='none'>None</option>";
  passiveTypes.forEach((type) => {
    optionsHtml += `<option value="${type}">${type}</option>`;
  });
  $("#overlays").html(optionsHtml);
}

function renderBiomeOptions() {
  var optionsHtml = "";
  biomes.forEach((type) => {
    optionsHtml += `<option value="${type}">${type}</option>`;
  });
  optionsHtml += "<option value='none'>Empty</option>";
  $("#biomes").html(optionsHtml);
}

function renderBuildingMenu() {
  var categories = [
    "Farm",
    "Ranch",
    "Terrain",
    "Industrial",
    "Trade",
    "BlockChain",
  ];
  var buildingsHTML = "";
  var categoryMenuHTML = "";
  categories.forEach((category) => {
    categoryMenuHTML += `<div class="categorybutton" id="${category}" onclick="showCategoryMenu('${category}')" title="${category}"><img src="./images/${category}-menu.png"/></div>`;

    buildingsHTML += `<div class="buildingshidden" id="${category}-menu">`;
    for (var building in townstarObjects) {
      if (excludedBuildings.includes(building)) continue;
      if (townstarObjects[building].Class == category) {
        buildingsHTML += `<div class="buildingmenubutton" id="${building}" title="${getPrettyName(
          building
        )}" onclick="selectBuilding('${building}')">
            <img src='${getTileIcon(building)}' />
        </div>`;
      }
    }
    buildingsHTML += `
<div class="buildingmenubutton buildingmenudeletebutton" id="remove" title="Remove" onclick="selectBuilding('remove')"
><img src='${getFullURL(removeIcon)}' /></div></div>`;
    $(".category").html(buildingsHTML);
  });
  $(".categories").html(categoryMenuHTML);
}

function clearGrid() {
  // //todo - this is kinda gross
  for (i = 0; i < 256; i++) {
    grid.grid[i].type = grid.defaultType;
  }
  // loadGrid();
  // renderBorders();
  renderGrid();
}

function loadGrid() {
  var gridHTML = "";
  for (i = 0; i < dimension * dimension; i++) {
    gridHTML += `<div id="cell${i}" class="cell" onclick="selectCell(this)"><i></i></div>`;
  }

  $(".gamegrid").html(gridHTML);
}

function selectCell(cell) {
  selected = cell.id;
  if (selectedBuilding != "") placeTile(selectedBuilding);
  renderStats();
  renderGrid();
}

function showCategoryMenu(type) {
  $(".buildings").attr("class", "buildingshidden");
  $("#" + type + "-menu").attr("class", "buildings");
}

function selectBorder(border) {
  var index = borderTypes.indexOf(grid[border]);

  index++;
  if (index > borderTypes.length - 1) index = 0;
  var newBorderType = borderTypes[index];
  grid[border] = newBorderType;
  // $("." + border).attr("class", border + " " + newBorderType);
  // selected = border.id;
  // $(".borderContext").show();
  renderBorders();
  renderGrid();
  renderStats();
  updateExportGrid();
}

function renderBorders() {
  borders.forEach((bdr) => {
    $(`#${bdr}`).attr("class", `${bdr} ${grid[bdr]}`);
  });
}

function selectBuilding(type) {
  $(".buildingmenubutton").removeClass("selectedbuildingmenubutton");
  if (selectedBuilding != type) {
    selectedBuilding = type;
    var existingClasses = $(`#${type}`).attr("class");
    $(`#${type}`).attr(
      "class",
      existingClasses + " selectedbuildingmenubutton"
    );
    if (type == "remove") {
      $(`.buildingmenudeletebutton`).attr(
        "class",
        existingClasses + " selectedbuildingmenubutton"
      );
    }
  } else {
    selectedBuilding = "";
  }
}

function placeTile(type) {
  var id = getCellIndex();
  if (id != null) {
    if (grid.grid[id].type == type || type == "remove") {
      grid.grid[id].type = grid.defaultType;
      grid.grid[id].edgeSatisfied = true;
    } else {
      grid.grid[id].type = type;
    }
    renderGrid();
    updateExportGrid();
  }
}

function updateExportGrid() {
  exportGrid.northborder = grid.northborder;
  exportGrid.southborder = grid.southborder;
  exportGrid.eastborder = grid.eastborder;
  exportGrid.westborder = grid.westborder;
  exportGrid.grid = grid.grid.map((cell) => {
    return {
      type: cell.type,
    };
  });
  $("#importexport").val(JSON.stringify(exportGrid));
}

function copyToClipboard() {
  var copyText = document.getElementById("importexport");

  copyText.select();
  copyText.setSelectionRange(0, 99999); /*For mobile devices*/

  document.execCommand("copy");
}

function updateOverlay(selection) {
  overlayMode = selection.value;
  renderGrid();
}

function updateBiome(selection) {
  biome = selection.value;
  loadTemplateGrid();
  renderGrid();
}

function updateDirection(selection) {
  direction = selection.value;
  loadTemplateGrid();
  renderGrid();
}

function renderStats() {
  var cell = grid.grid[getCellIndex()];
  if (!cell) return;
  // var building = buildings.filter((bdg) => bdg.Name == cell.type)[0];
  var building = townstarObjects[cell.type];
  if (building === undefined) return;
  console.log($(".tileinfopic"), getTileIcon(cell.type));
  $(".tileinfopic").html(
    `<span><img src='${getTileIcon(cell.type)}' /></span>`
  );
  $(".tileinfotitle").html(`<span>${getPrettyName(cell.type)}</span`);
  var buildingRecipies = building.Crafts.split(",");

  var recipesHTML = "";
  if (buildingRecipies.length != 0) {
    recipesHTML = "<span class='recipesheader'>Recipes</span>";
    buildingRecipies.forEach((rec) => {
      if (rec == "None") return;
      recipesHTML += `<div class="reciperow">
  <div class="recipeheader">${getPrettyName(rec)}&nbsp;${getRecipeTime(
        rec,
        cell
      )}</div>
  ${getIngredients(rec, cell)}
  </div>`;
    });
  }
  $(".recipes").html(recipesHTML);
}

function getRecipeTime(rec, cell) {
  var recipe = recipes[rec];
  var timesHTML = "";
  var penalty = -1;
  if (townstarObjects[cell.type].ProximityImmune == false) {
    penalty = getTimerClass(recipe.ProximityPenalty, cell);
  }
  timesHTML += `<span class="timer${
    penalty == 0 ? " timerselected" : ""
  } besttimer">${recipe.Time0}</span>`;
  timesHTML += `<span class="timer${
    penalty == 1 ? " timerselected" : ""
  } oktimer">${recipe.Time1}</span>`;
  timesHTML += `<span class="timer${
    penalty == 2 ? " timerselected" : ""
  } badtimer">${recipe.Time2}</span>`;
  timesHTML += `<span class="timer${
    penalty > 2 ? " timerselected" : ""
  } worsttimer">${recipe.Time3}</span>`;

  return timesHTML;
}

function getIngredients(rec, cell) {
  var ingredientHTML = "";
  for (i = 1; i < 4; i++) {
    if (recipes[rec]["Req" + i] == "none") return ingredientHTML;
    ingredientHTML += getIngredientRatio(
      recipes[rec]["Req" + i],
      recipes[rec]["Value" + i],
      cell
    );
  }
  return ingredientHTML;
}

function getIngredientRatio(ingredient, needed, cell) {
  var present = cell[ingredient] == undefined ? 0 : cell[ingredient];
  var ratio = `${present} / ${needed}`;

  return `<div class="ingredient">${getPrettyName(ingredient)}</span></div>
<div>${ratio}</div>`;
}

function getTimerClass(penaltyType, cell) {
  var totalPenalty = 0;
  if (cell.type == "Power_Plant") console.log(penaltyType);
  penaltyType.split(",").forEach((type) => {
    totalPenalty += cell[type];
  });

  return totalPenalty;
}

function renderGrid() {
  calculatePassiveEffects();
  calculateBorderEffects();
  calculateEdgeRequirements();
  var pageGrid = $(".gamegrid");
  for (i = 0; i < grid.grid.length; i++) {
    var cell = grid.grid[i];
    var classes = getClasses(cell);
    pageGrid.children().eq(i).attr("class", classes);
    pageGrid
      .children()
      .eq(i)
      .html(`<img src='${getTileIcon(cell.type)}' />`);
    setIconTitle(pageGrid.children().eq(i), cell);
  }
}

function getTileIcon(type) {
  switch (type) {
    case "Grass":
      return "./images/grass-icon.png";
    case "Marsh":
      return "./images/marsh-icon.png";
    case "Tree":
      return "./images/tree-icon.png";
    case "Rock":
      return "./images/rock-icon.png";
    case "Scrub":
      return "./images/scrub-icon.png";
    case "Arid":
      return "./images/arid-icon.png";
    case "Cactus":
      return "./images/cactus-icon.png";
    case "Oil_Seep":
      return "./images/seep-icon.png";
    default:
      return getFullURL(townstarObjects[type].FileUrl);
  }
}

function setIconTitle(divCell, cell) {
  var titleString = `${getPrettyName(cell.type)}`;
  passiveTypes.forEach((type) => {
    if (cell[type] != undefined && cell[type] != 0) {
      titleString += `\n${type}: ${cell[type]}`;
    }
  });

  divCell.children().eq(0).attr("title", titleString);
}

function getClasses(cell) {
  var classes = [];
  classes.push("cell");
  //classes.push(cell.type);
  if (getCellIndex() == i) classes.push("selected");
  passiveTypes.forEach((type) => {
    classes.push(getPenaltyClass(type, cell));
  });
  classes.push(getWateredClass(cell));
  if (!cell.edgeSatisfied) classes.push("noedge");
  return classes.join(" ");
}

function getCellIndex() {
  if (selected != "") {
    return parseInt(selected.substr(4));
  } else {
    return null;
  }
}

function getPenaltyClass(penaltyType, cell) {
  if (penaltyType == "Water") return "";
  if (penaltyType != overlayMode) return "";
  if (cell[penaltyType] >= 3) return "penaltyOverlay3Plus";
  if (cell[penaltyType] == 2) return "penaltyOverlay2";
  if (cell[penaltyType] == 1) return "penaltyOverlay1";

  return "";
}

function getWateredClass(cell) {
  if (cell.Water == 0 || overlayMode != "Water") return "";
  return "watered" + Math.min(cell.Water, 10);
}

function setValueForInnerSquare(center, value, property) {
  /*
__ __ __
|__|__|__|
|__|__|__|
|__|__|__|
*/
  var cellRow = Math.floor(center / dimension);
  var cellCol = center % dimension;
  for (x = cellRow - 1; x < cellRow + 2; x++) {
    if (x < 0) continue;
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * x + y;
      if (isOutOfBounds(index)) continue;
      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
}

function setValueFor2TileDistance(center, value, property) {
  /* 
__ __ __
__|__|__|__|__
|__|__|__|__|__|
|__|__|__|__|__|
|__|__|__|__|__|
|__|__|__|
*/
  var cellRow = Math.floor(center / dimension);
  var cellCol = center % dimension;
  //do 1s row above (not including corners)
  if (cellRow - 2 >= 0) {
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * (cellRow - 2) + y;
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s row below (not including corners)
  if (cellRow + 2 < dimension) {
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * (cellRow + 2) + y;
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s col to left
  if (cellCol - 2 >= 0) {
    for (y = cellRow - 1; y < cellRow + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * y + (cellCol - 2);
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s col to right
  if (cellCol + 2 < dimension) {
    for (y = cellRow - 1; y < cellRow + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * y + (cellCol + 2);
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
}

function setValueFor3TileDistance(center, value, property) {
  /* 
 __ __ __
__|__|__|__|__
__|__|__|__|__|__|__
|__|__|__|__|__|__|__|
|__|__|__|__|__|__|__|
|__|__|__|__|__|__|__|
|__|__|__|__|__|
|__|__|__|
*/

  var cellRow = Math.floor(center / dimension);
  var cellCol = center % dimension;
  //do 1s row above (not including corners)
  if (cellRow - 3 >= 0) {
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * (cellRow - 3) + y;
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s row below (not including corners)
  if (cellRow + 3 < dimension) {
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * (cellRow + 3) + y;
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s col to left
  if (cellCol - 3 >= 0) {
    for (y = cellRow - 1; y < cellRow + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * y + (cellCol - 3);
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s col to right
  if (cellCol + 3 < dimension) {
    for (y = cellRow - 1; y < cellRow + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * y + (cellCol + 3);
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }

  //get corners
  if (cellRow - 2 >= 0 && cellCol - 2 >= 0) {
    var index = dimension * (cellRow - 2) + (cellCol - 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow - 2 >= 0 && cellCol + 2 < dimension) {
    var index = dimension * (cellRow - 2) + (cellCol + 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow + 2 < dimension && cellCol - 2 >= 0) {
    var index = dimension * (cellRow + 2) + (cellCol - 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow + 2 < dimension && cellCol + 2 < dimension) {
    var index = dimension * (cellRow + 2) + (cellCol + 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
}

function setValueFor4TileDistance(center, value, property) {
  /* 
      __ __ __ 
   __|__|__|__|__
__|__|__|__|__|__|__
__|__|__|__|__|__|__|__|__
|__|__|__|__|__|__|__|__|__|
|__|__|__|__|__|__|__|__|__|
|__|__|__|__|__|__|__|__|__|
|__|__|__|__|__|__|__|
  |__|__|__|__|__|
     |__|__|__|
*/

  var cellRow = Math.floor(center / dimension);
  var cellCol = center % dimension;
  //do 1s row above (not including corners)
  if (cellRow - 4 >= 0) {
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * (cellRow - 4) + y;
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s row below (not including corners)
  if (cellRow + 4 < dimension) {
    for (y = cellCol - 1; y < cellCol + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * (cellRow + 4) + y;
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s col to left
  if (cellCol - 4 >= 0) {
    for (y = cellRow - 1; y < cellRow + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * y + (cellCol - 4);
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }
  //do 1s col to right
  if (cellCol + 4 < dimension) {
    for (y = cellRow - 1; y < cellRow + 2; y++) {
      if (y < 0 || y > dimension - 1) continue;
      var index = dimension * y + (cellCol + 4);
      if (isOutOfBounds(index)) continue;

      grid.grid[index][property] = grid.grid[index][property] + value;
    }
  }

  // //get corners
  //upper  left
  if (cellRow - 3 >= 0 && cellCol - 2 > 0) {
    var index = dimension * (cellRow - 3) + (cellCol - 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow - 2 >= 0 && cellCol - 3 >= 0) {
    var index = dimension * (cellRow - 2) + (cellCol - 3);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }

  //upper right
  if (cellRow - 3 >= 0 && cellCol + 2 < dimension) {
    var index = dimension * (cellRow - 3) + (cellCol + 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow - 2 >= 0 && cellCol + 3 < dimension) {
    var index = dimension * (cellRow - 2) + (cellCol + 3);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }

  //lower left
  if (cellRow + 3 < dimension && cellCol - 2 >= 0) {
    var index = dimension * (cellRow + 3) + (cellCol - 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow + 2 < dimension && cellCol - 3 >= 0) {
    var index = dimension * (cellRow + 2) + (cellCol - 3);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }

  //lower right
  if (cellRow + 3 < dimension && cellCol + 2 < dimension) {
    var index = dimension * (cellRow + 3) + (cellCol + 2);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
  if (cellRow + 2 < dimension && cellCol + 3 < dimension) {
    var index = dimension * (cellRow + 2) + (cellCol + 3);
    if (!isOutOfBounds(index))
      grid.grid[index][property] = grid.grid[index][property] + value;
  }
}

function getBuildingForCell(cellType) {
  var gridBuilding = buildings.filter((bdg) => bdg.Name == cellType);
  if (gridBuilding.length != 1) return null;

  var building = gridBuilding[0];
  if (building === undefined) return null;

  return building;
}

function calculatePassiveEffects() {
  resetAllPassive();
  for (i = 0; i < grid.grid.length; i++) {
    var cell = grid.grid[i];
    building = townstarObjects[cell.type];

    if (building == null) continue;
    if (building.ProximityEmit == "None") continue;

    var effectRadius = building.ProximityDist;
    if (effectRadius == 0) continue;
    var effects = building.ProximityEmit.split(",");

    for (effect in effects) {
      if (effectRadius == 1) {
        setValueForInnerSquare(i, 1, effects[effect]);
      }
      if (effectRadius == 2) {
        setValueForInnerSquare(i, 2, effects[effect]);
        setValueFor2TileDistance(i, 1, effects[effect]);
      }
      if (effectRadius == 3) {
        setValueForInnerSquare(i, 3, effects[effect]);
        setValueFor2TileDistance(i, 2, effects[effect]);
        setValueFor3TileDistance(i, 1, effects[effect]);
      }
      if (effectRadius == 4) {
        setValueForInnerSquare(i, 4, effects[effect]);
        setValueFor2TileDistance(i, 3, effects[effect]);
        setValueFor3TileDistance(i, 2, effects[effect]);
        setValueFor4TileDistance(i, 1, effects[effect]);
      }
    }
  }
}

function calculateBorderEffects() {
  resetProperty("Salty");
  var limit = 0;
  if (grid.northborder != "none") {
    var property = getBorderProperty(grid.northborder);
    limit = property == "Salty" ? 4 : 6;
    for (i = 0; i < limit; i++) {
      for (j = 0; j < dimension; j++) {
        var index = i * dimension + j;
        grid.grid[index][property] =
          grid.grid[index][property] + (limit - 1 - i);
      }
    }
  }
  if (grid.southborder != "none") {
    var property = getBorderProperty(grid.southborder);
    limit = property == "Salty" ? 4 : 6;
    for (i = 0; i < limit; i++) {
      for (j = 0; j < dimension; j++) {
        var index = (dimension - i - 1) * dimension + j;
        grid.grid[index][property] =
          grid.grid[index][property] + (limit - 1 - i);
      }
    }
  }
  if (grid.westborder != "none") {
    var property = getBorderProperty(grid.westborder);
    limit = property == "Salty" ? 4 : 6;
    for (j = 0; j < dimension; j++) {
      for (i = 0; i < limit; i++) {
        var index = j * dimension + i;
        grid.grid[index][property] =
          grid.grid[index][property] + (limit - 1 - i);
      }
    }
  }
  if (grid.eastborder != "none") {
    var property = getBorderProperty(grid.eastborder);
    limit = property == "Salty" ? 4 : 6;
    for (j = 0; j < dimension; j++) {
      for (i = 0; i < limit; i++) {
        var index = j * dimension + (dimension - i - 1);
        grid.grid[index][property] =
          grid.grid[index][property] + (limit - 1 - i);
      }
    }
  }
}

function isBorderTile(borderType, index) {
  return (
    (index < 16 && grid.northborder == borderType) ||
    (index > 240 && grid.southborder == borderType) ||
    (index % dimension == 0 && grid.westborder == borderType) ||
    (index % dimension == 15 && grid.eastborder == borderType)
  );
}

function calculateEdgeRequirements() {
  for (i = 0; i < grid.grid.length; i++) {
    var cell = grid.grid[i];

    var building = townstarObjects[cell.type];
    if (building == null) continue;

    if (
      building.EdgeRequirements != "None" &&
      building.EdgeRequirements != ""
    ) {
      var requirements = [];
      if (building.EdgeRequirements.indexOf(":AND:") >= 0) {
        requirements = building.EdgeRequirements.split(":AND:");
        var missingEdge = false;
        for (edgeType in requirements) {
          if (!hasEdge(requirements[edgeType], i)) {
            missingEdge = true;
            break;
          }
        }
        cell.edgeSatisfied = !missingEdge;
      } else {
        requirements = building.EdgeRequirements.split(":OR:");
        for (edgeType in requirements) {
          if (hasEdge(requirements[edgeType], i)) {
            cell.edgeSatisfied = true;
            break;
          } else {
            cell.edgeSatisfied = false;
          }
        }
      }
    }
  }
}

function hasEdge(edgeType, i) {
  if (
    //check borders
    (edgeType == "Waterway" &&
      (isBorderTile("Ocean", i) || isBorderTile("River", i))) ||
    (edgeType == "Mountain" && isBorderTile("Mountain", i)) ||
    ((edgeType == "OpenWorld" || edgeType == "Town") &&
      isBorderTile("none", i)) ||
    //check NSEW
    (!isOutOfBounds(i - dimension) &&
      isEdgeMatch(edgeType, grid.grid[i - dimension].type)) ||
    (!isOutOfBounds(i + dimension) &&
      isEdgeMatch(edgeType, grid.grid[i + dimension].type)) ||
    (!isOutOfBounds(i - 1) &&
      Math.floor(i / dimension) == Math.floor((i - 1) / dimension) &&
      isEdgeMatch(edgeType, grid.grid[i - 1].type)) ||
    (!isOutOfBounds(i + 1) &&
      Math.floor(i / dimension) == Math.floor((i + 1) / dimension) &&
      isEdgeMatch(edgeType, grid.grid[i + 1].type))
  ) {
    return true;
  }
  return false;
}

function isEdgeMatch(edge1, edge2) {
  //TODO: use EdgeClass of building objects if possible
  if (edge1 == "Road") {
    return edge2 == "Dirt_Road" || edge2 == "Paved_Road";
  }
  return edge1 == edge2;
}

function getBorderProperty(borderType) {
  switch (borderType) {
    case "River":
      return "Water";
    case "Ocean":
      return "Salty";
    case "Mountain":
      return "Shady";
  }
}

function getPrettyName(name) {
  return name.replaceAll("_", " ");
}

function getFullURL(assetPath) {
  return `https://townstar.sandbox-games.com/launch/${assetPath}`;
}

function getBuildingProperties(buildingType) {
  return buildings.filter((building) => building.Building == buildingType)[0];
}

function isOutOfBounds(index) {
  return (
    index == i || //don't water yourself
    index < 0 || //outside lower grid bound
    index >= grid.grid.length
  ); //outside upper grid bound
}

function resetAllPassive() {
  grid.grid.forEach((cell) => {
    passiveTypes.forEach((property) => {
      cell[property] = 0;
    });
  });
}

function resetProperty(property) {
  grid.grid.forEach((cell) => {
    cell[property] = 0;
  });
}
